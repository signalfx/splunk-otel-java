image:
  name: "openjdk:11.0.11-9-jdk"

before_script:
  # make sure zip is available - it's necessary to execute the buildpack script
  - apt-get update
  - apt-get -y install zip

stages:
  - build
  - release

build:
  stage: build
  script:
    - ./gradlew build -x :smoke-tests:test -x :testing:profiler-tests:test --scan --no-daemon --stacktrace

release:
  stage: release
  artifacts:
    paths:
      - dist/
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+.*/'
  script:
    # create release dir
    - mkdir -p dist
    # build the javaagent
    - ./gradlew -Prelease.useLastTag=true build final -x test --no-daemon
    - mv agent/build/libs/splunk-otel-javaagent-*-all.jar dist/splunk-otel-javaagent-all.jar
    # build the cloudfoundry buildpack
    - ./deployments/cloudfoundry/buildpack/build.sh
    - mv deployments/cloudfoundry/buildpack/splunk_otel_java_buildpack-linux.zip dist/
    # calculate checksums
    - shasum -a 256 dist/* > dist/checksums.txt
